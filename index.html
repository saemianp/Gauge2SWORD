<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Global Gauge Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    html, body, #map { height: 100%; margin: 0; }
    .toolbar {
      position: absolute; top: 10px; left: 10px; z-index: 1000;
      background: #fff; border-radius: 8px; padding: 8px; box-shadow: 0 2px 8px rgba(0,0,0,.15);
      font: 14px/1.3 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    }
    .toolbar .row { margin-bottom: 6px; }
    .toolbar input[type="text"] { width: 220px; padding: 6px 8px; border: 1px solid #ccc; border-radius: 6px; }
    .toolbar button { margin: 2px 2px 0 0; padding: 4px 10px; border: 1px solid #ccc; background: #f6f6f6; border-radius: 6px; cursor: pointer; }
    .toolbar button.active { background: #e3f2ff; border-color: #7bb8ff; }
    .popup-img {
      width: min(1000px, 90vw);
      height: auto;
      display: block;
      border-radius: 6px;
    }
    .leaflet-popup-content-wrapper,
    .leaflet-popup-content {
      width: auto !important;
      max-width: none !important;
      overflow-x: auto;
    }
    .popup-meta { font: 13px/1.5 system-ui, sans-serif; margin-top: 6px; }
    .hint { color: #666; font-size: 12px; }
  </style>
</head>
<body>
  <div class="toolbar">
    <div class="row">
      <b>Search:</b> <input id="searchBox" type="text" placeholder="Gauge name… (press Enter)"/>
    </div>
    <div class="row" id="continentButtons"><span class="hint">Loading continents…</span></div>
    <div class="row" id="loaderRow" style="display:none;">
      <button id="pickJsonBtn">Load gauges.json</button>
      <span class="hint">Use if your browser blocks local JSON.</span>
      <input id="jsonFileInput" type="file" accept="application/json" style="display:none;"/>
    </div>
  </div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const map = L.map('map', { worldCopyJump: true }).setView([15, 0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Fix missing marker icons when opened locally
    L.Icon.Default.mergeOptions({
      iconRetinaUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png',
      iconUrl:       'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
      shadowUrl:     'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png'
    });

    let gauges = [];
    let allMarkers = [];
    let continentGroups = {};
    let currentContinent = 'All';

    const continentButtonsDiv = document.getElementById('continentButtons');
    const loaderRow = document.getElementById('loaderRow');
    const pickJsonBtn = document.getElementById('pickJsonBtn');
    const jsonFileInput = document.getElementById('jsonFileInput');
    const searchBox = document.getElementById('searchBox');

    loadGaugesWithFallback();

    function loadGaugesWithFallback() {
      fetch('gauges.json')
        .then(r => {
          if (!r.ok) throw new Error('HTTP ' + r.status);
          return r.json();
        })
        .then(json => { gauges = json; initUIAndMarkers(); })
        .catch(err => {
          console.warn('Could not fetch gauges.json:', err);
          continentButtonsDiv.innerHTML = '<span class="hint">Could not auto-load gauges.json.</span>';
          loaderRow.style.display = 'block';
          pickJsonBtn.onclick = () => jsonFileInput.click();
          jsonFileInput.onchange = e => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = () => {
              try {
                gauges = JSON.parse(reader.result);
                initUIAndMarkers();
                loaderRow.style.display = 'none';
              } catch {
                alert('Invalid JSON file.');
              }
            };
            reader.readAsText(file);
          };
        });
    }

    function initUIAndMarkers() {
      const continents = Array.from(new Set(gauges.map(g => g.continent))).filter(Boolean).sort();
      const btns = ['All', ...continents].map(c => {
        const id = `btn-${c.replace(/\s+/g,'_')}`;
        return `<button id="${id}" data-cont="${c}">${c}</button>`;
      }).join('');
      continentButtonsDiv.innerHTML = `<b>Continent:</b> ${btns}`;
      ['All', ...continents].forEach(c => {
        const el = document.getElementById(`btn-${c.replace(/\s+/g,'_')}`);
        el.addEventListener('click', () => filterContinent(c));
      });
      document.getElementById('btn-All').classList.add('active');
      renderMarkers(gauges);
      searchBox.addEventListener('keydown', e => { if (e.key === 'Enter') searchByName(e.target.value.trim()); });
    }

    function renderMarkers(items) {
      allMarkers.forEach(m => m.remove());
      allMarkers = [];
      Object.values(continentGroups).forEach(g => map.removeLayer(g));
      continentGroups = {};

      items.forEach(g => {
        if (!isFinite(g.lat) || !isFinite(g.lon)) return;

        const popupHTML = `
          <div>
            ${g.img ? `<img class="popup-img" src="${g.img}" alt="${escapeHtml(g.gauge_name||'')}" />` : ''}
            <div class="popup-meta">
              ${g.gauge_name ? `<strong>${escapeHtml(g.gauge_name)}</strong><br/>` : ''}
              ${g.river ? `River: ${escapeHtml(g.river)}<br/>` : ''}
              ${g.source ? `Source: ${escapeHtml(g.source)}<br/>` : ''}
              ${g.station_id ? `Station ID: ${escapeHtml(g.station_id)}<br/>` : ''}
              ${isFinite(g.meanQ) ? `Mean Q: ${Number(g.meanQ).toLocaleString()} m³/s<br/>` : ''}
              ${g.kml ? `<a href="${g.kml}" target="_blank">KML file</a><br/>` : ''}
              ${g.mat ? `<a href="${g.mat}" target="_blank">MAT file</a>` : ''}
            </div>
          </div>`;

        const cont = g.continent || 'Unknown';
        if (!continentGroups[cont]) continentGroups[cont] = L.layerGroup().addTo(map);

        const marker = L.circleMarker([g.lat, g.lon], {
          radius: 6, fillOpacity: 0.85, weight: 1, color: '#1976d2'
        }).bindPopup(popupHTML, { maxWidth: 1200 });

        marker.addTo(continentGroups[cont]);
        marker._continent = cont;
        marker._name = (g.gauge_name || '').toLowerCase();
        allMarkers.push(marker);
      });

      const group = L.featureGroup(allMarkers);
      if (allMarkers.length) map.fitBounds(group.getBounds().pad(0.25));
      else map.setView([15,0], 2);
    }

    function filterContinent(continent) {
      currentContinent = continent;
      Array.from(continentButtonsDiv.querySelectorAll('button')).forEach(b => b.classList.remove('active'));
      const id = `btn-${continent.replace(/\s+/g,'_')}`;
      const btn = document.getElementById(id);
      if (btn) btn.classList.add('active');

      Object.entries(continentGroups).forEach(([c, layer]) => {
        if (continent === 'All' || continent === c) map.addLayer(layer); else map.removeLayer(layer);
      });

      const visible = allMarkers.filter(m => (continent==='All' || m._continent===continent));
      const grp = L.featureGroup(visible);
      if (visible.length) map.fitBounds(grp.getBounds().pad(0.25));
    }

    function searchByName(query) {
      if (!query) { filterContinent(currentContinent); return; }
      const q = query.toLowerCase();
      const results = allMarkers.filter(m => m._name.includes(q) && (currentContinent==='All' || m._continent===currentContinent));
      if (!results.length) { alert('No gauges match your search in the current filter.'); return; }
      const grp = L.featureGroup(results);
      map.fitBounds(grp.getBounds().pad(0.25));
      results[0].openPopup();
    }

    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }
  </script>
</body>
</html>
